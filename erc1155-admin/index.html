<body id="itrf">
  <meta charset="UTF-8" />
  <meta content="width=device-width, initial-scale=1.0" name="viewport" />
  <link href="./build.css" rel="stylesheet" />
  <link
    href="https://cdn.jsdelivr.net/npm/daisyui@4.10.3/dist/full.min.css"
    rel="stylesheet"
    type="text/css"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    rel="stylesheet"
    type="text/css"
  />

  <p class="hidden invisible" id="future_address"></p>
  <div class="p-2 hidden invisible">
    <div class="accordion">
      <div class="accordion-item">
        <section class="m-auto w-100">
          <h3 class="accordion-header text-center" id="headingOne">
            <button
              aria-controls="collapse_myAddr"
              aria-expanded="true"
              class="accordion-button collapsed"
              data-bs-target="#collapse_myAddr"
              data-bs-toggle="collapse"
              type="button"
            >
              myAddr
            </button>
          </h3>
          <div
            aria-labelledby="headingOne"
            class="accordion-collapse collapse"
            data-bs-parent="#accordionExample"
            id="collapse_myAddr"
          >
            <div class="accordion-body">
              <form class="d-flex flex-column gap-2 p-2" id="form-myAddr">
                <div>
                  <button
                    class="btn btn-primary mt-2"
                    data-form-name="myAddr"
                    id="btn"
                    type="button"
                  >
                    Read
                  </button>
                </div>
                <div>
                  <p>Response:</p>
                  <div>
                    :
                    <span
                      data-field-type="address"
                      data-form-name="myAddr"
                      id="form-output-myAddr-0"
                      >address</span
                    >
                    <br />
                  </div>
                </div>

                <script>
                  setTimeout(() => {
                    const element = document.getElementById("btn");
                    if (element) {
                      element.click();

                      setTimeout(() => {
                        const future_address =
                          document.getElementById("future_address");
                        future_address.innerHTML = document.getElementById(
                          "form-output-myAddr-0"
                        ).innerHTML;
                      }, 1000);
                    }
                  }, 1000);
                </script>
              </form>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <section
    class="pt-20 items-center flex-col gap-10 bg-base-100 flex"
    data-theme="dark"
    id="content"
    style="height: 1000px"
  >
    <h1 class="text-center text-3xl font-extrabold text-white">
      Soulbound Token (ERC1155) - Admin
    </h1>
    <h2
      id="collection-name"
      class="text-center text-xl font-semibold text-white"
    ></h2>
    <div class="px-10 pt-10">
      <button class="btn" onclick="my_modal_1.showModal()">Read info</button>
      <dialog class="modal" id="my_modal_1">
        <div class="modal-box">
          <b> Information about admin panel functions! </b>
          <br />
          <p class="py-4">
            <b>Mint</b> - create new SBT, enter the wallet address, token
            identifier and amount of tokens
            <br />
            <b>Set URI</b> - setting or changing the URI for the token metadata.
            <br />
            <b>Burn</b> - deleting existing NFTs. The administrator enters the
            wallet address, token ID, and the amount of tokens to be burned
            <br />
            <b>Transfer ownership</b> - transfer ownership of SBT collection or
            renounce ownership.
          </p>
          <div class="modal-action">
            <form method="dialog">
              <!-- if there is a button in form, it will close the modal -->
              <button class="btn">Close</button>
            </form>
          </div>
        </div>
      </dialog>
    </div>
    <div class="tabs tabs-boxed" role="tablist">
      <a
        class="tab tab-active transition-all duration-200"
        id="mint-tab"
        role="tab"
      >
        Mint
      </a>
      <a class="tab transition-all duration-200" id="set-tab" role="tab">
        Set URI
      </a>
      <a class="tab transition-all duration-200" id="burn-tab" role="tab">
        Burn
      </a>
      <a class="tab transition-all duration-200" id="transfer-tab" role="tab">
        Transfer ownership
      </a>
    </div>

    <div class="custom-card card w-96 bg-base-100 shadow-xl" id="tab-1">
      <form class="card-body flex flex-col space-y-4" id="mint_form">
        <div class="flex flex-col gap-2">
          <label for="mint_address">Wallet address</label>
          <input
            class="input input-bordered w-full max-w-xs"
            id="mint_address"
            name="mint_address"
            placeholder="Enter address"
            required
            type="text"
          />
        </div>
        <div class="flex flex-col gap-2">
          <label for="mint_id">Token ID</label>
          <input
            class="input input-bordered w-full max-w-xs"
            id="mint_id"
            name="mint_id"
            placeholder="Enter token id"
            required
            type="number"
          />
        </div>
        <div class="flex flex-col gap-2">
          <label for="mint_amount">Amount</label>
          <input
            class="input input-bordered w-full max-w-xs"
            id="mint_amount"
            name="mint_amount"
            placeholder="Enter amount"
            required
            type="number"
          />
        </div>
        <button class="btn btn-primary">Mint</button>
      </form>
    </div>

    <div class="custom-card w-96 bg-base-100 shadow-xl hidden" id="tab-2">
      <form class="card-body flex flex-col space-y-4" id="set_uri_form">
        <div class="flex flex-col gap-2">
          <label for="set_id">Token ID</label>
          <input
            class="input input-bordered w-full max-w-xs"
            id="set_id"
            name="set_id"
            placeholder="Enter id"
            required
            type="number"
          />
        </div>
        <div class="flex flex-col gap-2">
          <label for="set_uri">Metadata link</label>
          <input
            class="input input-bordered w-full max-w-xs"
            id="set_uri"
            name="set_uri"
            placeholder="Enter link"
            required
            type="text"
          />
        </div>
        <button class="btn btn-primary">Set URI</button>
      </form>
    </div>

    <div class="custom-card w-96 bg-base-100 shadow-xl hidden" id="tab-3">
      <form class="card-body flex flex-col space-y-4" id="burn_form">
        <div class="flex flex-col gap-2">
          <label for="burn_address">Wallet address</label>
          <input
            class="input input-bordered w-full max-w-xs"
            id="burn_address"
            name="burn_address"
            placeholder="Enter address"
            required
            type="text"
          />
        </div>
        <div class="flex flex-col gap-2">
          <label for="burn_id">Token ID</label>
          <input
            class="input input-bordered w-full max-w-xs"
            id="burn_id"
            name="burn_id"
            placeholder="Enter token id to burn"
            required
            type="number"
          />
        </div>
        <div class="flex flex-col gap-2">
          <label for="burn_amount">Amount</label>
          <input
            class="input input-bordered w-full max-w-xs"
            id="burn_amount"
            name="burn_amount"
            placeholder="Enter amount to burn"
            required
            type="number"
          />
        </div>
        <button class="btn btn-primary">Burn</button>
      </form>
    </div>

    <div class="custom-card w-96 bg-base-100 shadow-xl hidden" id="tab-4">
      <form
        class="card-body flex flex-col space-y-4"
        id="transfer_ownership_form"
      >
        <div class="flex flex-col gap-2">
          <label for="t_ownership"
            >Enter the address to whom you want to transfer ownership or leave
            blank to block access permanently (renounce ownership)</label
          >
          <input
            class="input input-bordered w-full max-w-xs"
            id="t_ownership"
            name="t_ownership"
            placeholder="Enter address or leave blank"
            type="text"
          />
        </div>
        <button class="btn btn-primary">Transfer ownership</button>
      </form>
    </div>
  </section>

  <script>
    const tabs = document.querySelectorAll(".tab");
    const cards = document.querySelectorAll(".custom-card");

    tabs.forEach((tab, index) => {
      tab.addEventListener("click", () => {
        // Remove 'tab-active' class from all tabs
        tabs.forEach((tab) => tab.classList.remove("tab-active"));
        // Add 'tab-active' class to the clicked tab
        tab.classList.add("tab-active");

        // Hide all cards
        cards.forEach((card) => {
          card.classList.add("hidden");
          card.classList.remove("card");
        });
        // Show the corresponding card (index + 1 because index is 0-based)
        document.getElementById(`tab-${index + 1}`).classList.remove("hidden");
        document.getElementById(`tab-${index + 1}`).classList.add("card");
      });
    });
  </script>

  <script src="https://unpkg.com/typed.js@2.1.0/dist/typed.umd.js"></script>

  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.12.1/ethers.umd.min.js"
    type="application/javascript"
  ></script>

  <script>
    const abi = [
      "constructor(string _name, string _symbol) payable",
      "event OwnershipTransferred(address indexed user, address indexed newOwner)",
      "event TransferBatch(address indexed operator, address indexed from, address indexed to, uint256[] ids, uint256[] amounts)",
      "event TransferSingle(address indexed operator, address indexed from, address indexed to, uint256 id, uint256 amount)",
      "event URI(string value, uint256 indexed id)",
      "function balanceOf(address, uint256) view returns (uint256)",
      "function balanceOfBatch(address[] owners, uint256[] ids) view returns (uint256[] balances)",
      "function batchBurn(address from, uint256[] tokenIds, uint256[] amounts)",
      "function batchMint(address to, uint256[] tokenIds, uint256[] amounts)",
      "function burn(address from, uint256 tokenId, uint256 amount)",
      "function mint(address to, uint256 tokenId, uint256 amount)",
      "function myAddr() view returns (address)",
      "function name() view returns (string)",
      "function owner() view returns (address)",
      "function setURI(uint256 tokenId, string tokenURI)",
      "function supportsInterface(bytes4 interfaceId) view returns (bool)",
      "function symbol() view returns (string)",
      "function transferOwnership(address newOwner)",
      "function uri(uint256 tokenId) view returns (string)",
    ];

    let contractAddress;

    const getAddress = async () => {
      setTimeout(() => {
        contractAddress = document.getElementById("future_address").innerHTML;
        console.log("Contract:", contractAddress);
      }, 2100);
    };

    getAddress();

    let provider;
    let signer;
    let connectContract;

    const initApp = async () => {
      // forward
      provider = new ethers.BrowserProvider(this.parent.ethereum);
      signer = await provider.getSigner();
      connectContract = new ethers.Contract(contractAddress, abi, signer);
      console.log("Account:", await signer.getAddress());
      // forward

      // test chain
      // const privateKey =
      //   "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80";
      // const provider = ethers.getDefaultProvider("http://localhost:8545/");
      // contractAddress = "0x5fbdb2315678afecb367f032d93f642f64180aa3";
      // const walletWithProvider = new ethers.Wallet(privateKey, provider);
      // const contract = new ethers.Contract(contractAddress, abi, provider);
      // connectContract = contract.connect(walletWithProvider);
      // test chain

      getCollectionName();
    };
    setTimeout(() => {
      initApp();
    }, 2500);

    const getCollectionName = async () => {
      const collectionName = await connectContract.name();
      const collectionSymbol = await connectContract.symbol();
      document.getElementById(
        "collection-name"
      ).innerText = `${collectionName} (${collectionSymbol})`;
    };
  </script>
  <script
    src="https://cdn.jsdelivr.net/npm/toastify-js"
    type="text/javascript"
  ></script>
  <script>
    const mintForm = document.getElementById("mint_form");
    const setUriForm = document.getElementById("set_uri_form");
    const burnForm = document.getElementById("burn_form");
    const transferOwnershipForm = document.getElementById(
      "transfer_ownership_form"
    );

    transferOwnershipForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      let error = false;
      const formData = new FormData(transferOwnershipForm);
      const to = formData.get("t_ownership");

      if (!to) {
        try {
          await connectContract.transferOwnership(
            "0x0000000000000000000000000000000000000000"
          );
          console.log(await connectContract.owner());
          Toastify({
            text: `Success renounce ownership!`,
            position: "right",
            gravity: "top",
          }).showToast();
        } catch (e) {
          console.log(e);
          Toastify({
            text: `Error call transferOwnership!`,
            position: "right",
            gravity: "top",
          }).showToast();
        }
      } else {
        if (!/^0x[a-fA-F0-9]{40}$/.test(to)) {
          Toastify({
            text: `Wrong address: ${to}`,
            position: "right",
            gravity: "top",
          }).showToast();
        }
        console.log(await connectContract.owner());
        error = true;
        if (!error) {
          try {
            await connectContract.transferOwnership(to);
            Toastify({
              text: `Success transferOwnership!`,
              position: "right",
              gravity: "top",
            }).showToast();
            console.log(await connectContract.owner());
            transferOwnershipForm.reset();
          } catch (e) {
            console.log(e);
            Toastify({
              text: `Error call transferOwnership!`,
              position: "right",
              gravity: "top",
            }).showToast();
          }
        }
      }
    });

    mintForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      let error = false;
      const formData = new FormData(mintForm);
      const to = formData.get("mint_address");
      const id = formData.get("mint_id");
      const amount = formData.get("mint_amount");

      if (!/^0x[a-fA-F0-9]{40}$/.test(to)) {
        Toastify({
          text: `Wrong address: ${to}`,
          className: "error",
          position: "right",
          gravity: "top",
        }).showToast();
        error = true;
      }
      if (!error) {
        try {
          await connectContract.mint(to, id, amount);
          mintForm.reset();
          Toastify({
            text: `Successfull mint!`,
            position: "right",
            gravity: "top",
          }).showToast();
        } catch (e) {
          console.log(e);
          Toastify({
            text: `Error call mint!`,
            position: "right",
            gravity: "top",
          }).showToast();
        }
      }
    });

    burnForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      let error = false;
      const formData = new FormData(burnForm);
      const from = formData.get("burn_address");
      const id = formData.get("burn_id");
      const amount = formData.get("burn_amount");

      if (!/^0x[a-fA-F0-9]{40}$/.test(from)) {
        Toastify({
          text: `Wrong address: ${from}`,
          className: "error",
          position: "right",
          gravity: "top",
        }).showToast();
        error = true;
      }

      if (!error) {
        try {
          await connectContract.burn(from, id, amount);
          burnForm.reset();
          Toastify({
            text: `Successfull burn!`,
            position: "right",
            gravity: "top",
          }).showToast();
        } catch (e) {
          console.log(e.reason);
          Toastify({
            text: `Error call burn! ${e.reason}`,
            position: "right",
            gravity: "top",
          }).showToast();
        }
      }
    });

    setUriForm.addEventListener("submit", async (event) => {
      event.preventDefault();
      let error = false;
      const formData = new FormData(setUriForm);
      const uri = formData.get("set_uri");
      const id = formData.get("set_id");

      if (!error) {
        try {
          await connectContract.setURI(id, uri);
          setUriForm.reset();
          Toastify({
            text: `Successfull set uri!`,
            position: "right",
            gravity: "top",
          }).showToast();
        } catch (e) {
          console.log(e);
          Toastify({
            text: `Error call!`,
            position: "right",
            gravity: "top",
          }).showToast();
        }
      }
    });
  </script>
</body>
