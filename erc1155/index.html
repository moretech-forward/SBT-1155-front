<body id="itrf">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link
    href="https://cdn.jsdelivr.net/npm/daisyui@4.10.2/dist/full.min.css"
    rel="stylesheet"
    type="text/css"
  />
  <link
    href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    rel="stylesheet"
    type="text/css"
  />

  <link href="./output.css" rel="stylesheet" />

  <p id="future_address" class="hidden invisible"></p>
  <div class="p-2 hidden invisible">
    <div class="accordion">
      <div class="accordion-item">
        <section class="m-auto w-100">
          <h3 id="headingOne" class="accordion-header text-center">
            <button
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#collapse_myAddr"
              aria-expanded="true"
              aria-controls="collapse_myAddr"
              class="accordion-button collapsed"
            >
              myAddr
            </button>
          </h3>
          <div
            id="collapse_myAddr"
            aria-labelledby="headingOne"
            data-bs-parent="#accordionExample"
            class="accordion-collapse collapse"
          >
            <div class="accordion-body">
              <form id="form-myAddr" class="d-flex flex-column gap-2 p-2">
                <div>
                  <button
                    id="btn"
                    type="button"
                    data-form-name="myAddr"
                    class="btn btn-primary mt-2"
                  >
                    Read
                  </button>
                </div>
                <div>
                  <p>Response:</p>
                  <div>
                    :
                    <span
                      id="form-output-myAddr-0"
                      data-form-name="myAddr"
                      data-field-type="address"
                      >address</span
                    >
                    <br />
                  </div>
                </div>

                <script>
                  setTimeout(() => {
                    const element = document.getElementById("btn");
                    if (element) {
                      element.click();

                      setTimeout(() => {
                        const future_address =
                          document.getElementById("future_address");
                        future_address.innerHTML = document.getElementById(
                          "form-output-myAddr-0"
                        ).innerHTML;
                      }, 1000);
                    }
                  }, 1000);
                </script>
              </form>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <section
    data-theme="dark"
    id="content"
    class="pt-20 flex items-center flex-col gap-10 min-h-screen bg-base-100"
  >
    <br />
    <h1 class="text-center text-3xl font-extrabold text-white">
      Soulbound Token (ERC1155)
    </h1>
    <h2
      id="collection-name"
      class="text-center text-xl font-semibold text-white"
    ></h2>
    <div role="tablist" class="tabs tabs-boxed">
      <a
        role="tab"
        id="my-sbt-tab"
        class="tab tab-active transition-all duration-200"
      >
        My SBT
      </a>
      <a role="tab" id="all-sbt-tab" class="tab transition-all duration-200">
        All SBT
      </a>
    </div>
    <div
      id="nft-cards"
      class="mx-auto px-[20px] max-w-[1170px] grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6"
    ></div>
  </section>

  <script
    src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"
    type="application/javascript"
  ></script>
  <script
    src="https://cdn.jsdelivr.net/npm/toastify-js"
    type="text/javascript"
  ></script>
  <script src="https://unpkg.com/typed.js@2.1.0/dist/typed.umd.js"></script>

  <script>
    const abi = [
      "constructor(string _name, string _symbol) payable",
      "event OwnershipTransferred(address indexed user, address indexed newOwner)",
      "event TransferBatch(address indexed operator, address indexed from, address indexed to, uint256[] ids, uint256[] amounts)",
      "event TransferSingle(address indexed operator, address indexed from, address indexed to, uint256 id, uint256 amount)",
      "event URI(string value, uint256 indexed id)",
      "function balanceOf(address, uint256) view returns (uint256)",
      "function balanceOfBatch(address[] owners, uint256[] ids) view returns (uint256[] balances)",
      "function batchBurn(address from, uint256[] tokenIds, uint256[] amounts)",
      "function batchMint(address to, uint256[] tokenIds, uint256[] amounts)",
      "function burn(address from, uint256 tokenId, uint256 amount)",
      "function mint(address to, uint256 tokenId, uint256 amount)",
      "function myAddr() view returns (address)",
      "function name() view returns (string)",
      "function owner() view returns (address)",
      "function setURI(uint256 tokenId, string tokenURI)",
      "function supportsInterface(bytes4 interfaceId) view returns (bool)",
      "function symbol() view returns (string)",
      "function transferOwnership(address newOwner)",
      "function uri(uint256 tokenId) view returns (string)",
    ];

    let provider, wallet, connectContract, address, contractAddress;

    const getAddress = async () => {
      setTimeout(() => {
        contractAddress = document.getElementById("future_address").innerHTML;
        console.log("Contract:", contractAddress);
      }, 2100);
    };

    getAddress();

    async function connectToContract() {
      // test chain
      // contractAddress = "0x5FbDB2315678afecb367f032d93F642f64180aa3";
      // const privateKey =
      //   "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80";
      // provider = new ethers.providers.JsonRpcProvider();
      // wallet = new ethers.Wallet(privateKey, provider);
      // connectContract = new ethers.Contract(contractAddress, abi, wallet);
      // test chain

      // forward
      provider = new ethers.providers.Web3Provider(this.parent.ethereum);
      wallet = await provider.getSigner();
      connectContract = new ethers.Contract(contractAddress, abi, wallet);
      // forward

      address = await wallet.getAddress();
      console.log("Account:", address);

      getCollectionName();
    }

    const getCollectionName = async () => {
      const collectionName = await connectContract.name();
      const collectionSymbol = await connectContract.symbol();
      document.getElementById(
        "collection-name"
      ).innerText = `${collectionName} (${collectionSymbol})`;
    };

    function shortenAddress(address) {
      if (address.length < 10) return address;
      return address.slice(0, 6) + "..." + address.slice(-5);
    }

    const customCallToast = (msg) => {
      Toastify({
        text: msg,
        position: "center",
        gravity: "top",
      }).showToast();
    };

    let nfts = [];

    const getNfts = async () => {
      nfts.length = 0;
      const get_nfts = await connectContract.queryFilter("TransferSingle");

      get_nfts.forEach((nft) => {
        nfts.push(nft.args);
      });
    };

    const getMyNfts = async (myAddress) => {
      nfts.length = 0;

      const get_nfts = await connectContract.queryFilter("TransferSingle");
      get_nfts.forEach((nft) => {
        if (nft.args.to === myAddress) {
          nfts.push(nft.args);
        }
      });
    };

    const renderNfts = async (nftsToRender) => {
      const section = document.getElementById("nft-cards");
      section.innerHTML = "";

      const nftMap = new Map();

      for (const nft of nftsToRender) {
        const key = `${nft.id}-${nft.to}`;
        if (
          !nftMap.has(key) &&
          nft.to !== "0x0000000000000000000000000000000000000000"
        ) {
          const balance = (
            await connectContract.balanceOf(nft.to, nft.id)
          ).toString();

          if (balance !== "0") {
            nftMap.set(key, {
              id: nft.id,
              to: nft.to,
              balance: balance,
            });
          }
        }
      }

      const nftResults = Array.from(nftMap.values()).sort((a, b) => {
        return a.id - b.id;
      });

      for (let nft of nftResults) {
        const ownerAddress = nft.to;
        const id = nft.id;
        const amount = nft.balance;

        try {
          const link = await connectContract.uri(id);
          let json = {
            name: "Name not defined",
            description: "Description not found",
            image:
              "https://via.assets.so/img.jpg?w=400&h=300&tc=blue&bg=#cecece",
          };

          if (link.startsWith("http")) {
            const res = await fetch(link);
            json = await res.json();
          } else {
            //customCallToast(`Invalid link for NFT with ID: ${id}`);
          }

          section.innerHTML += `
        <div class="card max-w-[320px] bg-base-100 shadow-xl">
            <figure>
                <img
                    src="${json.image}"
                    alt="NFT Image"
                    class="max-h-[250px] w-full object-cover"
                />
            </figure>
            <div class="card-body">
                <h2 class="card-title">${json.name}</h2>
                <div class="flex flex-col gap-2 text-xl font-medium">
                    <div class="flex items-center justify-between w-full">
                        <p>ID:</p> <p class="text-lg font-normal text-end">${id}</p>
                    </div>
                    <div class="flex items-center justify-between w-full">
                        <p>Owner:</p> <p class="text-lg font-normal text-end">${shortenAddress(
                          ownerAddress
                        )}</p>
                    </div>
                    <div class="flex items-center justify-between w-full">
                        <p>Amount:</p> <p class="text-lg font-normal text-end">${amount}</p>
                    </div>
                </div>
                <p>${json.description}</p>
            </div>
        </div>
      `;
        } catch (err) {
          const json = {
            name: "Name not defined",
            description: "Description not found",
            image:
              "https://via.assets.so/img.jpg?w=400&h=300&tc=blue&bg=#cecece",
          };

          section.innerHTML += `
        <div class="card max-w-[320px] bg-base-100 shadow-xl">
            <figure>
                <img
                    src="${json.image}"
                    alt="NFT Image"
                    class="max-h-[250px] w-full object-cover"
                />
            </figure>
            <div class="card-body">
                <h2 class="card-title">${json.name}</h2>
                <div class="flex flex-col gap-2 text-xl font-medium">
                    <div class="flex items-center justify-between w-full">
                        <p>ID:</p> <p class="text-lg font-normal text-end">${id}</p>
                    </div>
                    <div class="flex items-center justify-between w-full">
                        <p>Owner:</p> <p class="text-lg font-normal text-end">${shortenAddress(
                          ownerAddress
                        )}</p>
                    </div>
                    <div class="flex items-center justify-between w-full">
                        <p>Amount:</p> <p class="text-lg font-normal text-end">${amount}</p>
                    </div>
                </div>
                <p>${json.description}</p>
            </div>
        </div>
      `;

          //   customCallToast(`Failed to load NFT with ID: ${id}`);
        }
      }
    };

    document.addEventListener("DOMContentLoaded", () => {
      const mySbtTab = document.getElementById("my-sbt-tab");
      const allSbtTab = document.getElementById("all-sbt-tab");

      mySbtTab.addEventListener("click", () => {
        mySbtTab.classList.add("tab-active");
        allSbtTab.classList.remove("tab-active");
        getMyNfts(address).then(() => {
          renderNfts(nfts);
        });
      });

      allSbtTab.addEventListener("click", () => {
        allSbtTab.classList.add("tab-active");
        mySbtTab.classList.remove("tab-active");
        getNfts().then(() => {
          renderNfts(nfts);
        });
      });

      setTimeout(() => {
        mySbtTab.click();
      }, 3000);
    });

    setTimeout(() => {
      connectToContract();
    }, 2300);
  </script>
</body>
